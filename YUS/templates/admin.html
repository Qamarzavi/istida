<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Istidama Construction - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.9/Babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const LoginModal = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const response = await axios.post('http://localhost:5000/api/auth/login', {
                        email,
                        password
                    });
                    localStorage.setItem('token', response.data.token);
                    onLogin();
                    setError('');
                } catch (err) {
                    setError('Invalid credentials. Please try again.');
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center">
                    <div className="bg-white p-6 rounded-lg shadow-lg w-96">
                        <h2 className="text-2xl font-bold mb-4">Admin Login</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-2 border rounded"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-2 border rounded"
                                    required
                                />
                            </div>
                            {error && <p className="text-red-500">{error}</p>}
                            <button type="submit" className="bg-blue-500 text-white px-4 py-2 rounded w-full">Login</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ setActiveSection }) => (
            <div className="w-64 bg-gray-800 text-white h-screen fixed">
                <div className="p-4 text-2xl font-bold">Admin Dashboard</div>
                <nav className="mt-4">
                    <ul>
                        {['Dashboard', 'Users', 'Projects', 'Services', 'Testimonials', 'Contacts', 'Media', 'Pages', 'Emails', 'Notifications'].map(section => (
                            <li key={section}>
                                <button
                                    onClick={() => setActiveSection(section.toLowerCase())}
                                    className="w-full text-left p-4 hover:bg-gray-700"
                                >
                                    {section}
                                </button>
                            </li>
                        ))}
                    </ul>
                </nav>
            </div>
        );

        const SearchBar = ({ onSearch }) => {
            const [query, setQuery] = useState('');

            const handleSearch = (e) => {
                setQuery(e.target.value);
                onSearch(e.target.value);
            };

            return (
                <input
                    type="text"
                    value={query}
                    onChange={handleSearch}
                    placeholder="Search users, projects, services..."
                    className="w-full p-2 rounded border border-gray-300"
                />
            );
        };

        const Dashboard = ({ stats }) => {
            useEffect(() => {
                const ctx = document.getElementById('statsChart')?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Projects', 'Services', 'Contacts'],
                            datasets: [{
                                label: 'Total',
                                data: [
                                    stats.projects?.total || 0,
                                    stats.services?.total || 0,
                                    stats.contacts?.total || 0
                                ],
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true } } }
                    });
                }
            }, [stats]);

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-4">Dashboard Overview</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-blue-100 p-4 rounded">
                            <h3 className="text-lg font-semibold">Projects</h3>
                            <p>Total: {stats.projects?.total || 0}</p>
                            <p>Ongoing: {stats.projects?.ongoing || 0}</p>
                            <p>Completed: {stats.projects?.completed || 0}</p>
                        </div>
                        <div className="bg-green-100 p-4 rounded">
                            <h3 className="text-lg font-semibold">Services</h3>
                            <p>Total: {stats.services?.total || 0}</p>
                            <p>Featured: {stats.services?.featured || 0}</p>
                        </div>
                        <div className="bg-yellow-100 p-4 rounded">
                            <h3 className="text-lg font-semibold">Contacts</h3>
                            <p>Total: {stats.contacts?.total || 0}</p>
                            <p>New: {stats.contacts?.new || 0}</p>
                        </div>
                    </div>
                    <canvas id="statsChart" className="mt-6"></canvas>
                </div>
            );
        };

        const EntityList = ({ title, data, onEdit, onDelete, fields }) => (
            <div className="p-6">
                <h2 className="text-2xl font-bold mb-4">{title}</h2>
                <table className="w-full border-collapse">
                    <thead>
                        <tr className="bg-gray-200">
                            <th className="p-2">ID</th>
                            {fields.map(field => (
                                <th key={field} className="p-2">{field}</th>
                            ))}
                            <th className="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.map(item => (
                            <tr key={item._id} className="border-b">
                                <td className="p-2">{item._id}</td>
                                {fields.map(field => (
                                    <td key={field} className="p-2">{item[field] || 'N/A'}</td>
                                ))}
                                <td className="p-2">
                                    <button onClick={() => onEdit(item)} className="bg-blue-500 text-white px-2 py-1 rounded mr-2">Edit</button>
                                    <button onClick={() => onDelete(item._id)} className="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );

        const EntityForm = ({ title, initialData, onSubmit, fields }) => {
            const [formData, setFormData] = useState(initialData);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({ ...formData, [name]: value });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
                setFormData(initialData);
            };

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-4">{title}</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        {fields.map(field => (
                            <div key={field.name}>
                                <label className="block text-sm font-medium">{field.label}</label>
                                {field.type === 'textarea' ? (
                                    <textarea
                                        name={field.name}
                                        value={formData[field.name] || ''}
                                        onChange={handleChange}
                                        className="w-full p-2 border rounded"
                                    />
                                ) : (
                                    <input
                                        type={field.type || 'text'}
                                        name={field.name}
                                        value={formData[field.name] || ''}
                                        onChange={handleChange}
                                        className="w-full p-2 border rounded"
                                    />
                                )}
                            </div>
                        ))}
                        <button type="submit" className="bg-green-500 text-white px-4 py-2 rounded">Save</button>
                    </form>
                </div>
            );
        };

        const MediaManager = ({ media, onAdd, onDelete }) => {
            const [file, setFile] = useState(null);
            const [type, setType] = useState('image');

            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', type);
                onAdd(formData);
                setFile(null);
            };

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-4">Media Management</h2>
                    <form onSubmit={handleSubmit} className="mb-4">
                        <input
                            type="file"
                            onChange={(e) => setFile(e.target.files[0])}
                            className="mb-2"
                            accept={type === 'image' ? 'image/*' : 'video/*'}
                        />
                        <select
                            value={type}
                            onChange={(e) => setType(e.target.value)}
                            className="p-2 border rounded"
                        >
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                        <button type="submit" className="bg-green-500 text-white px-4 py-2 rounded ml-2">Upload</button>
                    </form>
                    <div className="grid grid-cols-3 gap-4">
                        {media.map(item => (
                            <div key={item._id} className="relative">
                                {item.type === 'image' ? (
                                    <img src={item.url} alt={item.name} className="w-full h-32 object-cover rounded" />
                                ) : (
                                    <video src={item.url} controls className="w-full h-32 object-cover rounded" />
                                )}
                                <button
                                    onClick={() => onDelete(item._id)}
                                    className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded"
                                >
                                    X
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const PageManager = ({ pages, onAdd, onEdit, onDelete }) => {
            const initialPage = { title: '', content: '', route: '' };
            const fields = [
                { name: 'title', label: 'Page Title' },
                { name: 'route', label: 'Route (e.g., /new-page)' },
                { name: 'content', label: 'Content (HTML)', type: 'textarea' }
            ];

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-4">Page Management</h2>
                    <EntityForm
                        title="Add New Page"
                        initialData={initialPage}
                        onSubmit={onAdd}
                        fields={fields}
                    />
                    <EntityList
                        title="Pages"
                        data={pages}
                        onEdit={onEdit}
                        onDelete={onDelete}
                        fields={['title', 'route']}
                    />
                </div>
            );
        };

        const EmailManager = ({ contacts, onSendEmail }) => {
            const [emailData, setEmailData] = useState({ recipient: '', subject: '', body: '' });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSendEmail(emailData);
                setEmailData({ recipient: '', subject: '', body: '' });
            };

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-4">Email Management</h2>
                    <form onSubmit={handleSubmit} className="mb-4 space-y-4">
                        <div>
                            <label className="block text-sm font-medium">Recipient Email</label>
                            <input
                                type="email"
                                value={emailData.recipient}
                                onChange={(e) => setEmailData({ ...emailData, recipient: e.target.value })}
                                className="w-full p-2 border rounded"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium">Subject</label>
                            <input
                                type="text"
                                value={emailData.subject}
                                onChange={(e) => setEmailData({ ...emailData, subject: e.target.value })}
                                className="w-full p-2 border rounded"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium">Email Body</label>
                            <textarea
                                value={emailData.body}
                                onChange={(e) => setEmailData({ ...emailData, body: e.target.value })}
                                className="w-full p-2 border rounded"
                            />
                        </div>
                        <button type="submit" className="bg-blue-500 text-white px-4 py-2 rounded">Send Email</button>
                    </form>
                    <EntityList
                        title="Recent Contacts"
                        data={contacts}
                        onEdit={() => {}}
                        onDelete={() => {}}
                        fields={['name', 'email', 'status']}
                    />
                </div>
            );
        };

        const NotificationManager = ({ notifications }) => (
            <div className="p-6">
                <h2 className="text-2xl font-bold mb-4">Notifications</h2>
                <ul>
                    {notifications.map((notification, index) => (
                        <li key={index} className="p-2 border-b">
                            {notification.message} - {new Date(notification.created_at).toLocaleString()}
                        </li>
                    ))}
                </ul>
            </div>
        );

        const App = () => {
            const [activeSection, setActiveSection] = useState('dashboard');
            const [stats, setStats] = useState({});
            const [users, setUsers] = useState([]);
            const [projects, setProjects] = useState([]);
            const [services, setServices] = useState([]);
            const [testimonials, setTestimonials] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [media, setMedia] = useState([]);
            const [pages, setPages] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [searchResults, setSearchResults] = useState([]);
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [isAuthenticated, setIsAuthenticated] = useState(!!token);

            const fetchData = async (endpoint, setter) => {
                try {
                    const response = await axios.get(`http://localhost:5000/api/${endpoint}`, {
                        headers: { 'x-access-token': token }
                    });
                    setter(response.data);
                } catch (error) {
                    console.error(`Failed to fetch ${endpoint}:`, error);
                    if (error.response?.status === 401) {
                        localStorage.removeItem('token');
                        setIsAuthenticated(false);
                        setToken(null);
                    }
                }
            };

            const handleSearch = async (query) => {
                if (!query || !isAuthenticated) {
                    setSearchResults([]);
                    return;
                }
                try {
                    const endpoints = ['admin/users', 'projects', 'services', 'testimonials', 'contacts'];
                    const results = await Promise.all(
                        endpoints.map(endpoint =>
                            axios.get(`http://localhost:5000/api/${endpoint}?search=${query}`, {
                                headers: { 'x-access-token': token }
                            }).then(res => res.data.map(item => ({ ...item, type: endpoint })))
                        )
                    );
                    setSearchResults(results.flat());
                } catch (error) {
                    console.error('Search failed:', error);
                    if (error.response?.status === 401) {
                        localStorage.removeItem('token');
                        setIsAuthenticated(false);
                        setToken(null);
                    }
                }
            };

            const handleAddMedia = async (formData) => {
                try {
                    const response = await axios.post('http://localhost:5000/api/media', formData, {
                        headers: { 'x-access-token': token, 'Content-Type': 'multipart/form-data' }
                    });
                    setMedia([...media, response.data]);
                    setNotifications([...notifications, {
                        message: `New ${formData.get('type')} uploaded`,
                        created_at: new Date()
                    }]);
                } catch (error) {
                    console.error('Failed to upload media:', error);
                }
            };

            const handleDeleteMedia = async (id) => {
                try {
                    await axios.delete(`http://localhost:5000/api/media/${id}`, {
                        headers: { 'x-access-token': token }
                    });
                    setMedia(media.filter(item => item._id !== id));
                    setNotifications([...notifications, {
                        message: `Media ${id} deleted`,
                        created_at: new Date()
                    }]);
                } catch (error) {
                    console.error('Failed to delete media:', error);
                }
            };

            const handleAddPage = async (pageData) => {
                try {
                    const response = await axios.post('http://localhost:5000/api/pages', pageData, {
                        headers: { 'x-access-token': token }
                    });
                    setPages([...pages, response.data]);
                    setNotifications([...notifications, {
                        message: `New page "${pageData.title}" created`,
                        created_at: new Date()
                    }]);
                } catch (error) {
                    console.error('Failed to add page:', error);
                }
            };

            const handleEditPage = async (pageData) => {
                try {
                    await axios.put(`http://localhost:5000/api/pages/${pageData._id}`, pageData, {
                        headers: { 'x-access-token': token }
                    });
                    setPages(pages.map(p => p._id === pageData._id ? pageData : p));
                    setNotifications([...notifications, {
                        message: `Page "${pageData.title}" updated`,
                        created_at: new Date()
                    }]);
                } catch (error) {
                    console.error('Failed to edit page:', error);
                }
            };

            const handleDeletePage = async (id) => {
                try {
                    await axios.delete(`http://localhost:5000/api/pages/${id}`, {
                        headers: { 'x-access-token': token }
                    });
                    setPages(pages.filter(p => p._id !== id));
                    setNotifications([...notifications, {
                        message: `Page ${id} deleted`,
                        created_at: new Date()
                    }]);
                } catch (error) {
                    console.error('Failed to delete page:', error);
                }
            };

            const handleSendEmail = async (emailData) => {
                try {
                    await axios.post('http://localhost:5000/api/emails/send', emailData, {
                        headers: { 'x-access-token': token }
                    });
                    setNotifications([...notifications, {
                        message: `Email sent to ${emailData.recipient}`,
                        created_at: new Date()
                    }]);
                } catch (error) {
                    console.error('Failed to send email:', error);
                }
            };

            useEffect(() => {
                if (isAuthenticated && token) {
                    fetchData('admin/dashboard/stats', (data) => setStats(data.stats));
                    fetchData('admin/users', setUsers);
                    fetchData('projects', setProjects);
                    fetchData('services', setServices);
                    fetchData('testimonials', setTestimonials);
                    fetchData('contacts', setContacts);
                    setMedia([
                        { _id: '1', name: 'Project Image', url: '/static/images/project1.jpg', type: 'image' },
                        { _id: '2', name: 'Construction Video', url: '/static/videos/construction.mp4', type: 'video' }
                    ]);
                    setPages([
                        { _id: '1', title: 'Home', route: '/', content: '<h1>Welcome</h1>' },
                        { _id: '2', title: 'About', route: '/about', content: '<h1>About Us</h1>' }
                    ]);
                    setNotifications([
                        { message: 'New contact received', created_at: new Date() },
                        { message: 'Testimonial pending approval', created_at: new Date() }
                    ]);
                }
            }, [isAuthenticated, token]);

            const renderSection = () => {
                if (!isAuthenticated) return null;
                if (searchResults.length > 0) {
                    return (
                        <EntityList
                            title="Search Results"
                            data={searchResults}
                            onEdit={() => {}}
                            onDelete={() => {}}
                            fields={['type', 'name', 'title', 'email']}
                        />
                    );
                }
                switch (activeSection) {
                    case 'dashboard':
                        return <Dashboard stats={stats} />;
                    case 'users':
                        return (
                            <EntityList
                                title="Users"
                                data={users}
                                onEdit={() => {}}
                                onDelete={(id) => axios.delete(`http://localhost:5000/api/admin/users/${id}`, { headers: { 'x-access-token': token } }).then(() => setUsers(users.filter(u => u._id !== id)))}
                                fields={['username', 'email', 'role']}
                            />
                        );
                    case 'projects':
                        return (
                            <EntityList
                                title="Projects"
                                data={projects}
                                onEdit={() => {}}
                                onDelete={(id) => axios.delete(`http://localhost:5000/api/projects/${id}`, { headers: { 'x-access-token': token } }).then(() => setProjects(projects.filter(p => p._id !== id)))}
                                fields={['title', 'status', 'location']}
                            />
                        );
                    case 'services':
                        return (
                            <EntityList
                                title="Services"
                                data={services}
                                onEdit={() => {}}
                                onDelete={(id) => axios.delete(`http://localhost:5000/api/services/${id}`, { headers: { 'x-access-token': token } }).then(() => setServices(services.filter(s => s._id !== id)))}
                                fields={['name', 'description', 'featured']}
                            />
                        );
                    case 'testimonials':
                        return (
                            <EntityList
                                title="Testimonials"
                                data={testimonials}
                                onEdit={() => {}}
                                onDelete={(id) => axios.delete(`http://localhost:5000/api/testimonials/${id}`, { headers: { 'x-access-token': token } }).then(() => setTestimonials(testimonials.filter(t => t._id !== id)))}
                                fields={['client_name', 'content', 'approved']}
                            />
                        );
                    case 'contacts':
                        return (
                            <EntityList
                                title="Contacts"
                                data={contacts}
                                onEdit={() => {}}
                                onDelete={(id) => axios.delete(`http://localhost:5000/api/contacts/${id}`, { headers: { 'x-access-token': token } }).then(() => setContacts(contacts.filter(c => c._id !== id)))}
                                fields={['name', 'email', 'status']}
                            />
                        );
                    case 'media':
                        return <MediaManager media={media} onAdd={handleAddMedia} onDelete={handleDeleteMedia} />;
                    case 'pages':
                        return <PageManager pages={pages} onAdd={handleAddPage} onEdit={handleEditPage} onDelete={handleDeletePage} />;
                    case 'emails':
                        return <EmailManager contacts={contacts} onSendEmail={handleSendEmail} />;
                    case 'notifications':
                        return <NotificationManager notifications={notifications} />;
                    default:
                        return <Dashboard stats={stats} />;
                }
            };

            return (
                <div>
                    {!isAuthenticated ? (
                        <LoginModal onLogin={() => setIsAuthenticated(true)} />
                    ) : (
                        <div className="flex">
                            <Sidebar setActiveSection={setActiveSection} />
                            <div className="ml-64 flex-1">
                                <div className="p-4 bg-gray-100">
                                    <SearchBar onSearch={handleSearch} />
                                </div>
                                {renderSection()}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>